#!/bin/sh -eu

. /usr/local/subr/io.subr

[ "$#" -eq 0 ] && exit 1

DIRS='/etc /usr/local/umbin /home/lancia/.lsr/lmbin /etc/init.d /usr/local/etc /usr/local/subr'
EXIT_CODE=0

for file in "$@"; do

	[ ! -f "$file" ] && continue

	FILENAME="${file##*/}"
	COUNTER=0

	for dir in $DIRS; do

		[ -e "$dir/$FILENAME" ] && COUNTER="$((COUNTER + 1))"

	done

	[ "$COUNTER" -eq 0 ] && continue
	[ "$COUNTER" -gt 1 ] && {

		TARGET_FILE="$dir/$FILENAME"
		print_warning "file \"$file\" exists in multiple locations:"
		for dir in $DIRS; do
			[ -e "$dir/$FILENAME" ] && echo "$dir/$FILENAME"
		done

	}

	for dir in $DIRS; do

		TARGET_FILE="$dir/$FILENAME"
		[ ! -e "$TARGET_FILE" ] && continue

		if [ "$TARGET_FILE" = "$file" ]; then

			print_warning "$TARGET_FILE and $file are the same, skipping..." 1>&2
			continue

		else

			OUTPUT="$(diff "$TARGET_FILE" "$file")" || {

				echo "---- $TARGET_FILE $file ----"
				echo "$OUTPUT"
				[ "$EXIT_CODE" -ne 1 ] && EXIT_CODE=1

			}

		fi

	done

done

exit "$EXIT_CODE"
