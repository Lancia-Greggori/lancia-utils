#!/bin/sh -eu

[ "$#" -eq 0 ] && exit 1

. /usr/local/subr/out.subr

DIRS='/etc /usr/local/umbin /home/lancia/.lsr/lmbin /etc/init.d /usr/local/etc /usr/local/subr'
EXIT_CODE=0
OUTPUT=''
VERBOSE=0
for arg in "$@"; do
	[ "$arg" = '-v' ] && VERBOSE=1
	break
done

diff_files()
{
	if [ "$VERBOSE" -eq 1 ]; then
		echo "($1 -- $2)" | sed 's|/mnt/storage/encrypted|/home|g'
		OUTPUT="$(diff "$1" "$2")" || {
			echo "$OUTPUT"
			[ "$EXIT_CODE" -ne 1 ] && EXIT_CODE=1
		}
	else
		diff -q "$1" "$2" 1>/dev/null || echo "$1" -- "$2"
	fi
}


for file in "$@"; do

	[ ! -f "$file" ] && continue

	OUTPUT="$(grep -m1 "^$(readlink -f "$file"):" /letc/global-filelist)" && {
		diff_files "$(echo "$OUTPUT" | cut -d':' -f1)" "$(echo "$OUTPUT" | cut -d':' -f2)"
		continue
	}

	for dir in $DIRS; do

		TARGET_FILE="$dir/${file##*/}"
		[ ! -e "$TARGET_FILE" ] && continue
		diff_files "$file" "$TARGET_FILE"

	done

done

exit "$EXIT_CODE"
