#!/bin/sh

set -eu

. /etc/sh.subr

FILE="$HOME/.tasks"
TASK_ID='t:'
CATEGORY_ID='c:'
RESERVED_CATEGORY_KEYWORDS='all'
OUTPUT=''
CMDLINE_NUMBER_OF_ARGS="$#"

if [ ! -e "$FILE" ]; then

	touch "$FILE"

else

	for keyword in $RESERVED_CATEGORY_KEYWORDS; do
		OUTPUT="$(grep "^${CATEGORY_ID}$keyword" "$FILE")" && {
			print_error 'reserved keywords used as categories in:'
			echo "$OUTPUT"
			exit 1
		}
	done

	OUTPUT="$(sort "$FILE" | uniq -cd)" && [ -n "$OUTPUT" ] && {
		print_error 'there are duplicate categories in the tasks file, remove it:'
		echo "$OUTPUT"
		exit 1
	}

	OUTPUT="$(grep -m1 -nvE "^($TASK_ID|$CATEGORY_ID)" "$FILE")" && {
		print_error 'bad file format:'
		echo "$OUTPUT"
		exit 1
	}

fi

[ "$#" -eq 0 ] && exit 1


needed_number_of_args()
{
	if [ "$CMDLINE_NUMBER_OF_ARGS" -lt "$1" ]; then
		print_error "need at least $1 argument(s)"
		exit 1
	fi
}

category_line_num()
{
	OUTPUT="$(grep -n "${CATEGORY_ID}$1" "$FILE" | cut -d':' -f1)"

	[ -z "$OUTPUT" ] && {
		print_error "category \"$1\" not found"
		exit 1
	}
}

add_task_to_category() { sed -i "$(category_line_num "$1")a ${TASK_ID}$2" "$FILE" ; }

list_category()
{
	i="$(category_line_num "$1")"
	echo "---$1"
	while true; do
		i="$((i+1))"
		OUTPUT="$(sed -n "${i}p" "$FILE")"
		echo "$OUTPUT" | grep -qv "^${TASK_ID}" && break
		echo "$OUTPUT" | sed "s/^${TASK_ID}//"
	done
}

write(){ echo "$1" >> "$FILE" ; }


case "$1" in

	a|a,t)
		needed_number_of_args 3

		add_task_to_category "$2" "$3"
	;;

	a,c)
		needed_number_of_args 2

		grep -q "${CATEGORY_ID}$2" "$FILE" && {
			print_error "category \"$2\" already exists"
			exit 1
		}

		write "${CATEGORY_ID}$2"
	;;

	l|l,c)
		needed_number_of_args 2

		[ "$2" = 'all' ] && exec sed "s/^${TASK_ID}//; s/^${CATEGORY_ID}/---/" "$FILE"

		list_category "$2"
	;;

	s,c)
		needed_number_of_args 2


	;;
	*) print_error "argument \"$1\" not recongnized" && exit 1 ;;

esac
